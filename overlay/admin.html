<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<title>Jonobotti ‚Äì Admin</title>

<style>
  :root {
    --bg: #0f0f13;
    --card: #1a1b23;
    --accent: #6c7cff;
    --danger: #e74c3c;
    --text: #ffffff;
    --muted: #9aa0b4;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    padding: 24px;
    font-family: "Segoe UI", Inter, system-ui, sans-serif;
    background: linear-gradient(180deg, #0f0f13, #0b0c10);
    color: var(--text);
  }

  h1 { margin: 0 0 12px 0; font-size: 22px; }
  h2 { margin: 0 0 12px 0; font-size: 16px; color: var(--muted); }

  .header {
    background: var(--card);
    padding: 16px 20px;
    border-radius: 14px;
    margin-bottom: 20px;
  }

  .status { display: flex; gap: 24px; margin-top: 8px; }
  .status span { font-size: 13px; color: var(--muted); }

  .cards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 20px;
  }

  .card {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .tab-btn {
    background: #212431;
    color: var(--muted);
    border: 1px solid #2a2c36;
  }

  .tab-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  button {
    background: var(--accent);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 12px 16px;
    font-size: 14px;
    cursor: pointer;
  }

  button.danger { background: var(--danger); }
  button.full { width: 100%; }

  ul { list-style: none; padding: 0; margin: 0; }

  li {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #2a2c36;
  }

  li:last-child { border-bottom: none; }

  .remove-btn {
    background: none;
    color: var(--danger);
    border: none;
    cursor: pointer;
    font-size: 14px;
    padding: 0;
  }

  .result-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 10px;
    align-items: center;
  }

  input {
    background: #0f1016;
    border: 1px solid #2a2c36;
    border-radius: 8px;
    padding: 10px;
    color: white;
    font-size: 14px;
  }

  input::placeholder { color: var(--muted); }

  .loop-create, .command-create {
    display: grid;
    grid-template-columns: 1fr 160px auto;
    gap: 10px;
    margin-bottom: 14px;
  }

  .loop-item, .command-item {
    display: grid;
    grid-template-columns: minmax(180px, 1fr) 120px auto auto auto;
    gap: 8px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #2a2c36;
  }

  .command-item {
    grid-template-columns: 180px minmax(180px, 1fr) auto auto;
  }

  .loop-item:last-child, .command-item:last-child { border-bottom: none; }

  .loop-meta {
    grid-column: 1 / -1;
    color: var(--muted);
    font-size: 12px;
  }

  .setup-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.72);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
  }

  .setup-modal-backdrop.show {
    display: flex;
  }

  .setup-modal {
    width: min(560px, 100%);
    background: #171923;
    border: 1px solid #303447;
    border-radius: 14px;
    padding: 18px;
  }

  .setup-modal h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
  }

  .setup-modal p {
    margin: 0 0 12px 0;
    color: var(--muted);
    line-height: 1.5;
  }

  .setup-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

</style>
</head>

<body>
  <div class="header">
    <h1>üéÆ Jonobotti ‚Äì Hallinta</h1>
    <div class="status">
      <div>
        <span>Nyt vuorossa</span><br>
        <strong id="current">-</strong>
      </div>
      <div>
        <span>Seuraavana</span><br>
        <strong id="next">-</strong>
      </div>
    </div>
  </div>

  <div id="setupModal" class="setup-modal-backdrop">
    <div class="setup-modal">
      <h3>üëã Tervetuloa k√§ytt√§m√§√§n moikkabottia</h3>
      <p>Ennen k√§ytt√∂√§ k√§y asettamassa Twitch-kanava <strong>Asetukset</strong>-v√§lilehdell√§.
      Kun tallennat asetukset, botti yritt√§√§ yhdist√§√§ automaattisesti ilman sovelluksen uudelleenk√§ynnistyst√§.</p>
      <div class="setup-actions">
        <button class="danger" onclick="dismissSetupModal()">My√∂hemmin</button>
        <button onclick="openSettingsFromModal()">Avaa asetukset</button>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button id="tabQueueBtn" class="tab-btn active" onclick="switchTab('queue')">üìã Jono</button>
    <button id="tabLoopBtn" class="tab-btn" onclick="switchTab('loop')">üîÅ Loop-viestit</button>
    <button id="tabCommandBtn" class="tab-btn" onclick="switchTab('commands')">‚ö° Custom Commands</button>
    <button id="tabSettingsBtn" class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Asetukset</button>
  </div>

  <section id="tabQueue" class="tab-content active">
    <div class="cards">
      <button class="full" onclick="send('next')">‚ñ∂Ô∏è Seuraava</button>
      <button class="full danger" onclick="send('clear')">üßπ Tyhjenn√§ jono</button>
    </div>

    <div class="card">
      <h2>üìã Jono</h2>
      <ul id="queue"></ul>
    </div>

    <div class="card" style="margin-top:20px;">
      <h2>üèÅ Pelin tulos</h2>
      <div class="result-grid">
        <input id="legsFor" type="number" placeholder="Pelaajan leg">
        <input id="legsAgainst" type="number" placeholder="Juontajan leg">
        <input id="avg" type="number" step="0.01" placeholder="Avg">
        <button onclick="submitResult()">üíæ</button>
      </div>
    </div>
  </section>

  <section id="tabLoop" class="tab-content">
    <div class="card">
      <h2>üîÅ Loop-viestit</h2>

      <div class="loop-create">
        <input id="loopMessage" type="text" placeholder="Viesti chattiin">
        <input id="loopInterval" type="number" min="1" step="1" placeholder="Aika (min)">
        <button onclick="createLoopMessage()">Lis√§√§</button>
      </div>

      <div id="loopList"></div>
    </div>
  </section>

  <section id="tabCommands" class="tab-content">
    <div class="card">
      <h2>‚ö° Custom Commands</h2>

      <div class="command-create">
        <input id="commandName" type="text" placeholder="Komento (esim. !dc)">
        <input id="commandResponse" type="text" placeholder="Vastaus chattiin">
        <button onclick="createCommand()">Lis√§√§</button>
      </div>

      <div id="commandList"></div>
    </div>
  </section>

  <section id="tabSettings" class="tab-content">
    <div class="card">
      <h2>‚öôÔ∏è Asetukset</h2>

      <div class="command-create">
        <input id="settingsChannel" type="text" placeholder="Twitch-kanava (ilman @)">
        <input id="settingsBotStatus" type="text" placeholder="Botin tila" disabled>
        <button onclick="saveSettings()">Tallenna</button>
      </div>

      <div style="color:#9aa0b4;font-size:13px;line-height:1.5;">
        <strong>Moikkabot adminiksi (moderaattoriksi):</strong><br>
        1) Avaa oma Twitch-kanavasi chat.<br>
        2) Kirjoita: <code>/mod moikkabot</code><br>
        3) Varmista, ett√§ botin k√§ytt√§j√§nimi vastaa t√§t√§ nime√§ botin asetuksissa/tokenissa.
      </div>
    </div>
  </section>

<script>
  const ws = new WebSocket(`ws://${location.host}`);
  let latestLoopMessages = [];
  let latestCustomCommands = [];
  let latestSettings = null;
  let setupPromptDismissed = false;

  function switchTab(tab) {
    const isQueue = tab === 'queue';
    const isLoop = tab === 'loop';

    document.getElementById('tabQueue').classList.toggle('active', isQueue);
    document.getElementById('tabLoop').classList.toggle('active', isLoop);
    const isCommands = tab === 'commands';
    const isSettings = tab === 'settings';

    document.getElementById('tabCommands').classList.toggle('active', isCommands);
    document.getElementById('tabSettings').classList.toggle('active', isSettings);

    document.getElementById('tabQueueBtn').classList.toggle('active', isQueue);
    document.getElementById('tabLoopBtn').classList.toggle('active', isLoop);
    document.getElementById('tabCommandBtn').classList.toggle('active', isCommands);
    document.getElementById('tabSettingsBtn').classList.toggle('active', isSettings);
  }

  function send(action, payload = null) {
    ws.send(JSON.stringify({ action, payload }));
  }

  function submitResult() {
    const legsFor = parseInt(document.getElementById('legsFor').value);
    const legsAgainst = parseInt(document.getElementById('legsAgainst').value);
    const avg = parseFloat(document.getElementById('avg').value);

    if (isNaN(legsFor) || isNaN(legsAgainst) || isNaN(avg)) {
      alert('T√§yt√§ kaikki kent√§t oikein');
      return;
    }

    send('result', { legsFor, legsAgainst, avg });

    document.getElementById('legsFor').value = '';
    document.getElementById('legsAgainst').value = '';
    document.getElementById('avg').value = '';
  }

  function createLoopMessage() {
    const message = document.getElementById('loopMessage').value.trim();
    const intervalMinutes = Number(document.getElementById('loopInterval').value);

    if (!message || !Number.isFinite(intervalMinutes) || intervalMinutes <= 0) {
      alert('Anna viesti ja ajastus minuutteina');
      return;
    }

    send('loop_add', { message, intervalMinutes });
    document.getElementById('loopMessage').value = '';
    document.getElementById('loopInterval').value = '';
  }

  function createCommand() {
    const name = document.getElementById('commandName').value.trim().toLowerCase();
    const response = document.getElementById('commandResponse').value.trim();

    if (!name.startsWith('!') || name.length < 2 || !response) {
      alert('Anna komento (!komento) ja vastaus');
      return;
    }

    send('command_add', { name, response });
    document.getElementById('commandName').value = '';
    document.getElementById('commandResponse').value = '';
  }

  function formatCountdown(seconds) {
    if (!Number.isFinite(seconds)) return '-';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${String(secs).padStart(2, '0')}`;
  }

  function renderLoopMessages() {
    const container = document.getElementById('loopList');
    container.innerHTML = '';

    if (!latestLoopMessages.length) {
      container.innerHTML = '<span style="color:#9aa0b4;">Ei ajastettuja loop-viestej√§.</span>';
      return;
    }

    latestLoopMessages.forEach(item => {
      const row = document.createElement('div');
      row.className = 'loop-item';

      const messageInput = document.createElement('input');
      messageInput.value = item.message;
      messageInput.placeholder = 'Viesti';

      const intervalInput = document.createElement('input');
      intervalInput.type = 'number';
      intervalInput.min = '1';
      intervalInput.step = '1';
      intervalInput.value = item.intervalMinutes;

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Tallenna';
      saveBtn.onclick = () => {
        const message = messageInput.value.trim();
        const intervalMinutes = Number(intervalInput.value);

        if (!message || !Number.isFinite(intervalMinutes) || intervalMinutes <= 0) {
          alert('Anna viesti ja kelvollinen ajastus');
          return;
        }

        send('loop_update', { id: item.id, message, intervalMinutes });
      };

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = item.enabled ? 'Pys√§yt√§' : 'K√§ynnist√§';
      toggleBtn.className = item.enabled ? 'danger' : '';
      toggleBtn.onclick = () => send('loop_toggle', { id: item.id, enabled: !item.enabled });

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Poista';
      deleteBtn.className = 'danger';
      deleteBtn.onclick = () => send('loop_delete', item.id);

      const meta = document.createElement('div');
      meta.className = 'loop-meta';
      meta.textContent = item.enabled
        ? `Aktiivinen ‚Ä¢ seuraava l√§hetys ~${formatCountdown(item.nextSendInSeconds)}`
        : 'Pois k√§yt√∂st√§';

      row.appendChild(messageInput);
      row.appendChild(intervalInput);
      row.appendChild(saveBtn);
      row.appendChild(toggleBtn);
      row.appendChild(deleteBtn);
      row.appendChild(meta);
      container.appendChild(row);
    });
  }

  function renderCommands() {
    const container = document.getElementById('commandList');
    container.innerHTML = '';

    if (!latestCustomCommands.length) {
      container.innerHTML = '<span style="color:#9aa0b4;">Ei custom-komentoja.</span>';
      return;
    }

    latestCustomCommands.forEach(item => {
      const row = document.createElement('div');
      row.className = 'command-item';

      const nameInput = document.createElement('input');
      nameInput.value = item.name;

      const responseInput = document.createElement('input');
      responseInput.value = item.response;

      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Tallenna';
      saveBtn.onclick = () => {
        const name = nameInput.value.trim().toLowerCase();
        const response = responseInput.value.trim();

        if (!name.startsWith('!') || name.length < 2 || !response) {
          alert('Anna komento (!komento) ja vastaus');
          return;
        }

        send('command_update', { id: item.id, name, response });
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Poista';
      deleteBtn.className = 'danger';
      deleteBtn.onclick = () => send('command_delete', item.id);

      row.appendChild(nameInput);
      row.appendChild(responseInput);
      row.appendChild(saveBtn);
      row.appendChild(deleteBtn);
      container.appendChild(row);
    });
  }


  function saveSettings() {
    const channel = document.getElementById('settingsChannel').value.trim().toLowerCase();

    if (!channel) {
      alert('Anna Twitch-kanavan nimi');
      return;
    }

    send('settings_save', { channel });
  }

  function renderSettings() {
    if (!latestSettings) return;

    document.getElementById('settingsChannel').value = latestSettings.channel || '';
    document.getElementById('settingsBotStatus').value = latestSettings.botConnected
      ? 'Yhdistetty'
      : 'Ei yhdistetty';
  }


  function openSettingsFromModal() {
    switchTab('settings');
    dismissSetupModal();
  }

  function dismissSetupModal() {
    setupPromptDismissed = true;
    document.getElementById('setupModal').classList.remove('show');
  }

  function maybeShowSetupModal() {
    if (!latestSettings || latestSettings.setupCompleted) {
      setupPromptDismissed = false;
      document.getElementById('setupModal').classList.remove('show');
      return;
    }

    if (setupPromptDismissed) return;

    const modal = document.getElementById('setupModal');
    modal.classList.add('show');
  }

  ws.onmessage = event => {
    const data = JSON.parse(event.data);

    document.getElementById('current').textContent = data.current ?? '-';
    document.getElementById('next').textContent = data.next ?? '-';

    const ul = document.getElementById('queue');
    ul.innerHTML = '';

    data.queue.forEach((name, i) => {
      const li = document.createElement('li');
      li.textContent = `${i + 1}. ${name}`;

      const btn = document.createElement('button');
      btn.textContent = '‚ùå';
      btn.className = 'remove-btn';
      btn.onclick = () => send('remove', name);

      li.appendChild(btn);
      ul.appendChild(li);
    });

    latestLoopMessages = data.loopMessages || [];
    latestCustomCommands = data.customCommands || [];
    latestSettings = data.settings || null;
    renderLoopMessages();
    renderCommands();
    renderSettings();
    maybeShowSetupModal();
  };
</script>

</body>
</html>
